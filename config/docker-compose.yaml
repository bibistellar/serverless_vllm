version: '3.8'

services:
  manager:
    build:
      context: .
      dockerfile: Dockerfile.manager
    container_name: llm_manager
    ports:
      - "9000:9000"
    environment:
      - MANAGER_HOST=0.0.0.0
      - MANAGER_PORT=9000
    networks:
      - llm_network
    restart: unless-stopped

  worker1:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: llm_worker1
    ports:
      - "7001:7000"
    environment:
      - WORKER_ID=worker-1
      - WORKER_HOST=0.0.0.0
      - WORKER_PORT=7000
      - MANAGER_URL=http://manager:9000
    volumes:
      - /path/to/models:/models  # 挂载模型目录
      - /var/run/docker.sock:/var/run/docker.sock  # 如果需要在容器内管理 Docker
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - llm_network
    depends_on:
      - manager
    restart: unless-stopped

  worker2:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: llm_worker2
    ports:
      - "7002:7000"
    environment:
      - WORKER_ID=worker-2
      - WORKER_HOST=0.0.0.0
      - WORKER_PORT=7000
      - MANAGER_URL=http://manager:9000
    volumes:
      - /path/to/models:/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - llm_network
    depends_on:
      - manager
    restart: unless-stopped

  router:
    build:
      context: .
      dockerfile: Dockerfile.router
    container_name: llm_router
    ports:
      - "8000:8000"
    environment:
      - ROUTER_HOST=0.0.0.0
      - ROUTER_PORT=8000
      - MANAGER_URL=http://manager:9000
    networks:
      - llm_network
    depends_on:
      - manager
    restart: unless-stopped

networks:
  llm_network:
    driver: bridge
